<div class='category_manager'>
  {{#if error}}
    <p class='error'>{{error}}</p>
  {{else}}
    <div class='header'>
      <h1>Categories Management</h1>
      <button onclick='openModal()'>Add New Category</button>
    </div>

    <table>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Description</th>
        <th>Action</th>
      </tr>
      {{#each categories}}
        <tr>
          <td>{{id}}</td>
          <td>{{name}}</td>
          <td>{{description}}</td>
          <td>
            <button class='btn-edit' onclick='openEditModal({{id}})'>Edit</button>
            <button class='btn-delete' onclick='deleteCategoryConfirmation({{id}})'>Delete</button>
          </td>
        </tr>
      {{/each}}
    </table>

    <!-- Edit Category Modal -->
    <div id='editCategoryModal' class='modal'>
      <div class='modal-content'>
        <span class='close' onclick='closeEditModal()'>&times;</span>
        <h2>Edit Category</h2>
        <form id='editCategoryForm'>
          <input type='hidden' id='editCategoryId' name='editCategoryId' />
          <label for='editCategoryName'>Category Name:</label>
          <input type='text' id='editCategoryName' name='editCategoryName' required />

          <label for='editCategoryDescription'>Category Description:</label>
          <input type='text' id='editCategoryDescription' name='editCategoryDescription' required />

          <button type='button' onclick='saveEditedCategory()'>Save Changes</button>
        </form>
      </div>
    </div>

    <!-- Add Category Modal -->
    <div id='addCategoryModal' class='modal'>
      <div class='modal-content'>
        <span class='close' onclick='closeModal()'>&times;</span>
        <h2>Add Category</h2>
        <form id='addCategoryForm'>
          <label for='categoryName'>Category Name:</label>
          <input type='text' id='categoryName' name='categoryName' required />

          <label for='categoryDescription'>Category Description:</label>
          <input type='text' id='categoryDescription' name='categoryDescription' required />

          <button type='button' onclick='addCategory()'>Add Category</button>
        </form>
      </div>
    </div>

    <div id="confirmDelete" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeDeleteModal()">&times;</span>
        <h2>Are you sure you want to delete this category?</h2>
        <button type="button" onclick="deleteCategory()">Yes</button>
        <button type="button" onclick="closeDeleteModal()">No</button>
      </div>
    </div>

    <script>
      function openModal() {
        document.getElementById('addCategoryModal').style.display = 'flex';
      }

      function closeModal() {
        document.getElementById('addCategoryModal').style.display = 'none';
      }

      function openEditModal(categoryId) {
        fetch(`/admin/categories/${categoryId}`)
          .then(response => response.json())
          .then(category => {
            document.getElementById('editCategoryId').value = category.id;
            document.getElementById('editCategoryName').value = category.name;
            document.getElementById('editCategoryDescription').value = category.description;
            document.getElementById('editCategoryModal').style.display = 'flex';
          })
          .catch(error => {
            console.error('Error fetching category details:', error);
          });
      }

      function closeEditModal() {
        document.getElementById('editCategoryModal').style.display = 'none';
      }

      function saveEditedCategory() {
        const categoryId = document.getElementById('editCategoryId').value;
        const editedCategoryName = document.getElementById('editCategoryName').value;
        const editedCategoryDescription = document.getElementById('editCategoryDescription').value;

        fetch(`/admin/categories/${categoryId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: editedCategoryName,
            description: editedCategoryDescription,
          }),
        })
          .then(response => response.json())
          .then(editedCategory => {
            closeEditModal();
            location.reload(true);
          })
          .catch(error => {
            console.error('Error updating category:', error);
          });
      }

      function deleteCategoryConfirmation(categoryId) {
        var confirmDelete = confirm("Are you sure you want to delete this category?");
        if (confirmDelete) {
          deleteCategory(categoryId);
        }
      }

      function deleteCategory(categoryId) {
        fetch(`/admin/categories/${categoryId}`, {
          method: 'DELETE',
        })
          .then(response => {
            if (!response.ok) {
              throw new Error(`Error deleting category: ${response.statusText}`);
            }
            location.reload(true);
          })
          .catch(error => {
            console.error(error);
          });
      }

      function addCategory(event) {
        const categoryName = document.getElementById('categoryName').value;
        const categoryDescription = document.getElementById('categoryDescription').value;

        console.log(categoryName);
        console.log(categoryDescription);

        fetch('/admin/categories', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: categoryName,
            description: categoryDescription,
          }),
        })
          .then(response => response.json())
          .then(newCategory => {
            location.reload(true);
          })
          .catch(error => {
            console.error('Error adding category:', error);
          });

        closeModal();
      }
    </script>
  {{/if}}
</div>
